<meta http-equiv="refresh" content="120">

<style type="text/css">
	a {font-size:12px;color:green;text-decoration:none}
	td {padding:15px 10px 5px 10px;border-bottom:solid 1px #ccc;font-family:Verdana}
	.proxy {font-size:12px;color:#aaa}
	div {font-family:Verdana}
	.geo {font-weight:bold;font-size:10px}
</style>

<table style="width:100%">

<tr>
	<td style="width:15%"></td>
	<td style="width:65%"></td>
	<td style="width:10%"></td>
	<td style="width:10%"></td>
</td>

<?php

	include('config.php');
	include('database.class.php');

	new database();

	session_start();

	if (isset($_SESSION['ip_data']))
		$ip_data = $_SESSION['ip_data'];
	else
		$ip_data = array();

	$curl = curl_init();
	curl_setopt($curl, CURLOPT_HEADER, 0);
	curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);

	$q_ip = mysql_query("SELECT client_ip FROM `log` ORDER BY `log`.`time` DESC LIMIT 0,30");
	$q = mysql_query("SELECT client_ip, request, proxy, time + INTERVAL 10 HOUR FROM `log` ORDER BY `log`.`time` DESC LIMIT 0,30");

	$ip_addr = array();
	while ($r = mysql_fetch_row($q_ip))
		if (!in_array($r[0],$ip_addr) && !isset($ip_data[$r[0]]))
			$ip_addr[] = $r[0];

	if (count($ip_addr)>0)
	{
		curl_setopt($curl, CURLOPT_POST, 1);
		curl_setopt($curl, CURLOPT_POSTFIELDS, "ips=".implode("%0D%0A",$ip_addr)."&type=&u=&p=");
		curl_setopt($curl, CURLOPT_URL, "http://www.maxmind.com/app/locate_demo_ip");
		curl_setopt($curl, CURLOPT_PROXY, "www29096u.sakura.ne.jp:80");
		$data = curl_exec($curl);
		curl_setopt($curl, CURLOPT_PROXY, "");
		curl_setopt($curl, CURLOPT_POST, 0);
	}

	$data = substr($data,0,strpos($data,'These results were generated'));
	$i = strpos($data,'<th>Hostname</th>');
	while ($i = strpos($data,'<tr>',$i))
	{
		$i += 4;
		$i = strpos($data,'-1">',$i) + 4;
		$ip = substr($data,$i,strpos($data,'<',$i)-$i);
		$i = strpos($data,'-1">',$i) + 4;
		$i = strpos($data,'-1">',$i) + 4;
		$country = substr($data,$i,strpos($data,'<',$i)-$i);
		$i = strpos($data,'-1">',$i) + 4;
		$i = strpos($data,'-1">',$i) + 4;
		$i = strpos($data,'-1">',$i) + 4;
		$city = substr($data,$i,strpos($data,'<',$i)-$i);
		$country = explode(' ',$country);
		$country = $country[0];
		$ip_data[$ip] = $country.' | '.$city;
	}

	while ($r = mysql_fetch_row($q))
	{
		if (!isset($ip_data[$r[0]]))
		{
			curl_setopt($curl, CURLOPT_URL, "http://api.hostip.info/get_html.php?ip={$r[0]}");
			$data = curl_exec($curl);
			if ($data!==false)
			{
				$data = explode("\n",$data);
				$data[0] = explode(" ",$data[0]);
				$data[1] = explode(":",$data[1]);
				if (strpos($data[1][1],'Unknown')!==false)
					$data[1][1] = '*';
				if (strpos($data[0][1],'Unknown')!==false)
					$data[0][1] = '*';
				$data = trim($data[0][1]).', '.trim($data[1][1]);
			}
			$ip_data[$r[0]] = $data;
		}
		else
			$data = $ip_data[$r[0]];
		$time = explode(' ',$r[3]);
		$time = $time[1];
		$title = $r[1];
		if (strlen($title)>100)
			$title = substr($title,0,100).'...';
		echo "<tr><td>{$r[0]}<br><span class=\"geo\">$data</span></td><td><a href=\"{$r[1]}\" target=\"_new\">$title</a></td><td class=\"proxy\">{$r[2]}</td><td>$time</td></tr>";
	}

	$_SESSION['ip_data'] = $ip_data;

	curl_close($curl);

?>

</table>

<div style="padding:50px">
<p><b>Proxy Status</b></p>

<?php

	$q = mysql_query("SELECT proxy_name,active FROM proxys ORDER BY proxy_name");
	while ($r = mysql_fetch_row($q))
	{
		if ($r[1]==1)
			echo '<font color="green">active</font>';
		else
			echo '<font color="red">stopped</font>';
		echo '&nbsp;'.$r[0].'<br>';
	}

?>

</div>

<?php

	exit();

?>
